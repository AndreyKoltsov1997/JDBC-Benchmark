#!groovy

def SUCCESS_MESSAGE_OUTPUT_COLOR = '\033[1;32m'
def FAILURE_MESSAGE_OUTPUT_COLOR = '\033[0;31m'

final EMPTY_COMMIT_TAG = "empty_commit_tag"
final DEFAULT_IMAGE_TAG = "latest"

pipeline {
    /* The agent directive, which is required, instructs Jenkins to allocate an executor and workspace for the Pipeline */        
    // NOTE: Using different agent on different jobs 
    agent any

    stages {
        stage("YAML file tests") {
            steps {
                script {
                    def testFile = readFile("${env.WORKSPACE}/test.yaml")
                    echo "testFile: $testFile"
                    def newCountry = "USA"
                    testFile = testFile.replaceFirst(/country: '.*'/, "country: '${newCountry}'")
                    echo "Updated YAML file: $testFile"

                    try {
                        def testFileInfo = readYaml(file: "${env.WORKSPACE}/test.yaml")
                    } catch (Exception error) {
                        println error.getClass()
                        echo "File not found exception."
                    }
                    echo "Test file info: $testFileInfo"
                    echo "testFileInfo.country: $testFileInfo.country"
                    testFileInfo.country = "Canada"
                    echo "Updated testFileInfo.country: $testFileInfo.country"
                    testFileInfo.nonExistingField = "I do not exist."
                    echo "testFileInfo.nonExistingField: $testFileInfo.nonExistingField"

                    fileOperations([fileDeleteOperation(excludes: "", includes: 'test.yaml')])

                    sh "ls"
                    echo "File has been deleted."
                    writeYaml(file: "${env.WORKSPACE}/test.yaml", data: testFileInfo)

                    def updatedFile = readFile("${env.WORKSPACE}/test.yaml")
                    echo "Updated file content: $updatedFile"
                    sh "cat test.yaml"


                }
            }
        }
    }
    post {
        failure {
            script {
                // NOTE: In case job in step 1 has failed, it executes AFTER all the other jobs.
                echo "Caught failure."
            }
        }
    }
}
